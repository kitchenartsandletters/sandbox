{%- comment -%} --- Damaged UI (new & damaged pages) --- {%- endcomment -%}
{%- assign conditions = 'light,moderate,heavy' | split: ',' -%}
{%- assign is_damaged_page = false -%}
{%- assign current_condition = '' -%}
{%- assign base_handle = product.handle -%}

{%- for c in conditions -%}
  {%- assign slug = '-' | append: c | append: '-damage' -%}
  {%- assign slug_len = slug | size -%}
  {%- assign handle_len = product.handle | size -%}
  {%- assign start_index = handle_len | minus: slug_len -%}
  {%- assign end_of_handle = product.handle | slice: start_index, slug_len -%}
  {%- if end_of_handle == slug -%}
    {%- assign is_damaged_page = true -%}
    {%- assign current_condition = c -%}
    {%- assign base_handle = product.handle | slice: 0, start_index -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}
Build links from the **base** handle only (prevents â€¦-damage-â€¦-damage).
This is at most 3 all_products lookups.
{%- endcomment -%}
{%- assign damaged_links = '' -%}
{%- for c in conditions -%}
  {%- assign h = base_handle | append: '-' | append: c | append: '-damage' -%}
  {%- assign p = all_products[h] -%}
  {%- if p and p != blank and p.available -%}
    {%- assign link_html = '<p><a href="' 
        | append: p.url 
        | append: '" class="damaged-book-link">View Damaged Copy (' 
        | append: c 
        | append: ')</a></p>' -%}
    {%- assign damaged_links = damaged_links | append: link_html -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Teaser: show on NEW book pages only {%- endcomment -%}
{%- unless is_damaged_page -%}
  {%- if damaged_links != blank -%}
    <div class="damaged-book-section">
      <p>Don't need a perfect copy? Below are available damaged copies.</p>
      {{ damaged_links }}
    </div>
  {%- endif -%}
{%- endunless -%}

{%- comment -%} Damaged page callout + back link {%- endcomment -%}
{%- if is_damaged_page -%}
  {%- assign main_product = all_products[base_handle] -%}
  {%- case current_condition -%}
    {%- when 'light' -%}
      {%- assign condition_copy = "<strong>Light damage</strong> means that the book shows one or more minor bumps to its edges or corners which are cosmetically unsatisfying but don't affect the book's usefulness." -%}
    {%- when 'moderate' -%}
      {%- assign condition_copy = "<strong>Moderate damage</strong> means that the book may have noticeable cosmetic damage to its exterior or a few pages which are wrinkled or torn." -%}
    {%- when 'heavy' -%}
      {%- assign condition_copy = "<strong>Heavy damage</strong> means that the book is somehow weakened, usually by damages to its spine that mean it will have to be handled carefully to preserve its usefulness." -%}
  {%- endcase -%}

  <div class="damaged-condition-callout">
    <p>We received some copies of this book which are less than perfect. While supplies last, we are offering these copies at a reduced price.  These copies are first come, first served: we cannot reserve one for you. And we cannot predict when we might receive more once we sell out of them, mostly because we really don't want to get any more damaged copies. ðŸ˜Š</p>
    <p>When you order one of these books, we'll use our judgment to choose the best remaining copy for you in the category you choose. Purchases of damaged books are <strong>final sales: they are not refundable or exchangeable.</strong></p>
    {%- if condition_copy -%}<p>{{ condition_copy }}</p>{%- endif -%}
    {%- if main_product and main_product != blank -%}
      <p><a href="{{ main_product.url }}" class="damaged-book-link">Prefer a new copy?</a></p>
    {%- endif -%}
  </div>
{%- endif -%}